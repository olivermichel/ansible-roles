---
- hosts: all
  user: root

  tasks:
  - name: set hostname
    hostname: name={{ hostname }}
    when: hostname is defined

  - name: update /etc/hosts
    lineinfile:
      dest=/etc/hosts
      regexp="^127\.0\.1\.1"
      line="127.0.1.1{{'\t'}}{% if hostname != fqdn %}{{ fqdn }}{{'\t'}}{% endif %}{{ hostname }}"
      state=present
